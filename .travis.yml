language: minimal

services:
  - docker

stages:
  - agent base container
  - agent tool containers

env:
  global:
    - DOCKER_ORG=ustctt
    - DOCKER_REPO=ctt-agent
    - DOCKER_ORG_REPO="${DOCKER_ORG}/${DOCKER_REPO}"

jobs:
  include:
    - stage: agent base container
      name: "Build agent base container"
      env: 
        - TAG="${DOCKER_ORG_REPO}:base"
      before_script:
        - docker login -u "${DOCKER_USERNAME}" -p "${DOCKER_PASSWORD}"
      script: 
        - docker build -t "${TAG}" test-tool-modules/
        - docker push "${TAG}"
    - stage: agent tool containers
      name: "Build agent tool container for ${AGENT}"
      env:
        - AGENT=jmeter
        - AGENT=apachebench
        - TAG="${DOCKER_ORG_REPO}:${AGENT}"
      before_script:
        - docker login -u "${DOCKER_USERNAME}" -p "${DOCKER_PASSWORD}"
      script:
        - docker build -t "${TAG}" "test-tool-modules/${AGENT}/"
        - docker push "${TAG}"

